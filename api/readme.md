# WALLACLONE - API REST


## PURPOSE
7th practice for 7 Bootcamp KeepCoding. Upgrade https://github.com/nexus-code/practica-backendnode-1 according to the following requirements:
1. Authentication
2. Internationalization
3. Image upload with background task



## REQUIREMENTS

* Node.js 
* MongoDB 
* Mongoose
* Port 3021 free
* Optional (but strongly recomended): 
    - PM2 https://pm2.keymetrics.io/ 
    - Postman: https://www.getpostman.com/



## BEFORE START: Initialize demo images and DB (autogenerated).

This script generate DB, add demo adverts and default user (user@example.com / 1234), removing previous deployments:

* First of all, config variables in .env file (copy .env.example and rename to .env)
1. node installDB.js
2. node installImages.js



## START:
* With PM2: 
    1. It is recommended execute "pm2 delete all" to kill previous processes
    2. pm2 start ecosystem.config.js
* Without PM2:
    1. node imageService.js
    2. npm run dev


## FRONT
* https://localhost:3021/



## API
To access API and obtain JWT login with email and pass go to: https://localhost:3021/apiv1/login, next, with token call to:
* ADS Url:  https://localhost:3021/apiv1/adverts
* TAGS Url: https://localhost:3021/apiv1/tags    // list available tags 

Token must be send on body, or query string or header
Default user: user@example.com / clave 1234

### CRUD methods (into Ad model)
* POST   -> https://localhost:3021/apiv1/adverts/ . Insert new adverts with image
The image is upladed to uploadverts folder. On insert (in models/Ads.js) 


* PUT    -> https://localhost:3021/apiv1/adverts/_id for update ad by _id
* DELETE -> https://localhost:3021/apiv1/adverts/_id for delete ad by _id
* GET    -> View API Calls



### PARAMS (API & view)
1. type   -> true: for sale / false: for search
2. active -> true (by default)/ false
3. name   -> Starts with value
4. text   -> Text is searched in description (Full text search)
5. Price  -> a. X: exact value
             b. Y-X:  Y <= adverts.price <= X
             c. X- :  adverts.price <= X
             d. -X :  X <= adverts.price
6. Tags   -> Current values: work, lifestyle, motor & mobile. Use ',' for filter. 
7. _id    -> Find by document _id

### API CALL with params examples
* https://localhost:3021/apiv1/adverts?price=-79 | https://localhost:3021/apiv1/adverts?price=51- | https://localhost:3021/apiv1/adverts?price=20-80
* https://localhost:3021/apiv1/adverts?text=a%20long%20time%20ago&active=false
* https://localhost:3021/apiv1/adverts?text=consectetur%20adipiscing%20elit
* https://localhost:3021/apiv1/adverts?tags=work&priceMax=80
* https://localhost:3021/apiv1/adverts?active=false
* https://localhost:3021/?tags=motor,work
* https://localhost:3021/?id= document._id


### API CALL with sort & pagination
* By default sort by price
* Use skip, limit & sort (price ASC by default). Only in API, use fields to specify which of them to show or hide

### API Results
* status -> Server's response. Value 200 indicates that query work
* result -> Array of adverts/tags. Can be empty
* error  -> if any



## Final notes
* AdBlock or others browser ad blockers can throw errors with images.
* Connection problems with Postman & HTTPs could solved with: https://stackoverflow.com/questions/47806876/could-not-get-any-response-response-when-using-postman-with-subdomain



## Ad schema
const advertSchema = mongoose.Schema({
    name: {
        type: String,
        require: true,
        minlength: 3,
        maxlength: 50,
        trim: true,
    },
    type: {
        type: String,
        require: true,
        default: 'sell'
    },
    owner: {
        type: mongoose.Schema.Types.ObjectId,
        ref: "User"
    },
    price: {
        require: true,
        type: Number,
        min: 0,
    },
    image: {
        type: String,
        default: ''
    },
    tags: {
        type: [String],
        require: true,
    },
    status: {
        type: String,
        require: true,
        default: ''
    },
    active: {
        type: Boolean,
        default: true,
    },
    description: {
        type: String,
        require: true,
        minlength: 15,
        maxlength: 500,
    },
    created: { type: Date, default: Date.now },
    updated: { type: Date }    
});
